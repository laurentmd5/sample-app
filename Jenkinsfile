pipeline {
    agent any
    
    environment {
        // Configuration Application
        APP_NAME = 'go-dev-dashboard'
        APP_PORT = '8090'
    
        // Configuration Docker
        DOCKER_REGISTRY = 'laurentmd5'
        DOCKER_IMAGE = "${APP_NAME}"
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        
        // Configuration Serveur Ubuntu
        DEPLOY_SERVER = 'devops@localhost'
        DEPLOY_PATH = '/home/devops/apps'
        SSH_CREDENTIALS_ID = 'ubuntu-server-ssh'
        
        // Configuration Go
        GOPATH = '/var/lib/jenkins/go'
    }
    
    stages {
        // √âTAPE 1: Checkout avec credentials GitHub
        stage('Checkout Code') {
            steps {
                git branch: 'master',
                    url: 'https://github.com/laurentmd5/sample-app.git',
                    credentialsId: 'my-token'

                sh '''
                echo "üì¶ Repository: https://github.com/laurentmd5/sample-app.git"
                echo "üìù Branch: master"
                echo "üîç Files in repository:"
                ls -la
                echo "=== Go files ==="
                find . -name "*.go" -type f
                '''
            }
        }
        
        // √âTAPE 2: Setup Go Environment
        stage('Setup Go') {
            steps {
                sh '''
                echo "üîß Setting up Go environment..."
                go version
                which go
                
                mkdir -p /var/lib/jenkins/go
                chown jenkins:jenkins /var/lib/jenkins/go
                
                whoami
                pwd
                '''
            }
        }
        
        // √âTAPE 3: Build Go Application
        stage('Build Go Application') {
            steps {
                sh '''
                echo "üèóÔ∏è Building Go application..."
                
                if [ ! -f "go.mod" ]; then
                    echo "üìù Initializing go.mod..."
                    go mod init go-dev-dashboard
                fi

                go mod tidy
                go mod download

                go build -v -o ${APP_NAME} .

                echo "‚úÖ Build completed:"
                ls -la ${APP_NAME}
                file ${APP_NAME}
                '''
            }
        }

        // √âTAPE 4: Static Code Analysis (GoSec)
        stage('Static Code Analysis') {
            steps {
                sh '''
                echo "üîç Running GoSec security analysis..."
                go install github.com/securego/gosec/v2/cmd/gosec@latest
                export PATH=$PATH:$(go env GOPATH)/bin
                gosec ./... || echo "‚ö†Ô∏è Gosec found issues (non-blocking)"
                '''
            }
        }

        // √âTAPE 5: Dynamic Tests (Unit tests + Coverage)
        stage('Dynamic Tests') {
            steps {
                sh '''
                echo "üß™ Running unit tests with coverage..."
                go test ./... -v -coverprofile=coverage.out || echo "‚ö†Ô∏è Tests failed"
                go tool cover -func=coverage.out | tee coverage-report.txt
                '''
            }
        }

        // √âTAPE 6: Static Analysis simplifi√©e
        stage('Static Analysis') {
            steps {
                sh '''
                echo "üîç Running basic static analysis..."
                go vet . || echo "‚ö†Ô∏è Go vet issues"
                go build -o /tmp/test-build . && echo "‚úÖ Code compiles"
                rm -f /tmp/test-build
                '''
            }
        }

        // √âTAPE 7: Build Docker Image
        stage('Build Docker Image') {
            steps {
                sh '''
                echo "üê≥ Building Docker image..."
                echo "=== Dockerfile Content ==="
                cat Dockerfile
                echo "=========================="

                docker build -t ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG} .
                docker tag ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:latest

                echo "‚úÖ Docker images created:"
                docker images | grep ${DOCKER_REGISTRY}
                '''
            }
        }

        // √âTAPE 8: Container Scan (Trivy)
        stage('Container Scan') {
            steps {
                sh '''
                echo "üõ°Ô∏è Scanning Docker image for vulnerabilities (Trivy)..."
                trivy image --quiet --no-progress --severity HIGH,CRITICAL ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:latest || echo "‚ö†Ô∏è Vulnerabilities found"
                '''
            }
        }

        // √âTAPE 9: Filesystem Scan (Trivy FS)
        stage('Filesystem Scan') {
            steps {
                sh '''
                echo "üßæ Scanning source filesystem for vulnerabilities..."
                trivy fs --quiet --no-progress --severity HIGH,CRITICAL . || echo "‚ö†Ô∏è Issues found in filesystem"
                '''
            }
        }

        // √âTAPE 10: Deploy to Ubuntu via SSH
        stage('Deploy to Ubuntu via SSH') {
            steps {
                script {
                    withCredentials([sshUserPrivateKey(
                        credentialsId: "${SSH_CREDENTIALS_ID}",
                        usernameVariable: 'SSH_USER',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                        echo "üöÄ Deploying to Ubuntu server..."
                        ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${DEPLOY_SERVER} "
                            set -e
                            echo 'üéØ Starting deployment of ${APP_NAME}...'

                            docker stop ${APP_NAME} 2>/dev/null || true
                            docker rm ${APP_NAME} 2>/dev/null || true
                            docker image prune -f 2>/dev/null || true

                            docker run -d \\
                              --name ${APP_NAME} \\
                              -p ${APP_PORT}:${APP_PORT} \\
                              --restart unless-stopped \\
                              ${DOCKER_REGISTRY}/${APP_NAME}:latest

                            sleep 10
                            docker ps --filter 'name=${APP_NAME}' --format 'table {{.Names}}\\t{{.Status}}'

                            if curl -f -s http://localhost:${APP_PORT}/ > /dev/null; then
                                echo '‚úÖ Health check passed'
                            else
                                echo '‚ö†Ô∏è Health check failed'
                                docker logs ${APP_NAME} --tail 10
                            fi
                        "
                        """
                    }
                }
            }
        }

        // √âTAPE 11: Environment Scan (Lynis + apt audit)
        stage('Environment Scan') {
            steps {
                script {
                    withCredentials([sshUserPrivateKey(
                        credentialsId: "${SSH_CREDENTIALS_ID}",
                        usernameVariable: 'SSH_USER',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                        echo "üßÆ Running environment security scan..."
                        ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${DEPLOY_SERVER} "
                            sudo apt update -qq
                            sudo apt install -y lynis > /dev/null 2>&1 || true
                            sudo lynis audit system --quiet || echo '‚ö†Ô∏è Lynis found warnings'
                        "
                        """
                    }
                }
            }
        }

        // √âTAPE 12: Final Check
        stage('Final Check') {
            steps {
                sh '''
                echo "üîÅ Final verification..."
                echo "üì¶ Checking Docker containers status..."
                docker ps --format "table {{.Names}}\t{{.Status}}"
                echo "‚úÖ Pipeline and deployment verification complete!"
                '''
            }
        }
    }
    
    post {
        always {
            sh '''
            echo "üßº Cleaning up workspace..."
            docker system prune -f 2>/dev/null || true
            rm -f ${APP_NAME} 2>/dev/null || true
            '''
            archiveArtifacts artifacts: '${APP_NAME},go.mod,*.go,coverage-report.txt', fingerprint: true
        }
        success {
            sh """
            echo "‚úÖ D√âPLOIEMENT R√âUSSI!"
            echo "üåê Application disponible sur:"
            echo "   http://localhost:${APP_PORT}"
            echo "   http://192.168.61.131:${APP_PORT}"
            """
        }
        failure {
            sh """
            echo "‚ùå D√âPLOIEMENT √âCHOU√â"
            echo "üí° V√©rifiez les logs Jenkins et les scans Trivy/Lynis."
            """
        }
    }
}
