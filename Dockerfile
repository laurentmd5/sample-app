# ==============================
# üî® STAGE 1 ‚Äî Build
# ==============================
FROM golang:1.23.2-alpine AS builder

# Labels pour tra√ßabilit√©
LABEL maintainer="Laurent MAVOUNGOU <dev@yourdomain.com>"
LABEL description="Go Dev Dashboard - outil de monitoring et s√©curit√© pour d√©veloppeurs freelances"

WORKDIR /app

# Copie des fichiers sources et initialisation du module
COPY go.mod ./
# Copie optionnelle du fichier go.sum s‚Äôil existe
# (utilise une commande shell dans RUN car COPY ne supporte pas les jokers avec fallback)
RUN test -f go.sum && cp go.sum . || true

# Initialisation et r√©cup√©ration des d√©pendances
RUN go mod init go-dev-dashboard || true
RUN go mod tidy

# Copie du reste du code source
COPY . .

# Compilation statique (s√©curis√©e et portable)
RUN CGO_ENABLED=0 GOOS=linux go build -a -o /go-dev-dashboard .

# ==============================
# üßä STAGE 2 ‚Äî Final image
# ==============================
FROM gcr.io/distroless/base-debian11

WORKDIR /

# Copie du binaire depuis le builder
COPY --from=builder /go-dev-dashboard /go-dev-dashboard

# Port d‚Äô√©coute de l‚Äôapplication
ENV PORT=8090

# Utilisateur non-root pour s√©curit√©
USER nonroot:nonroot

# Exposition du port (facilite debug Docker)
EXPOSE 8090

# Commande de d√©marrage
ENTRYPOINT ["/go-dev-dashboard"]
