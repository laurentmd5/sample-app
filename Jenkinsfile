pipeline {
    agent any
    
    environment {
        // Configuration Application
        APP_NAME = 'hello-app'
        APP_PORT = '8090'
        
        // Configuration Docker
        DOCKER_REGISTRY = 'laurentmd5'
        DOCKER_IMAGE = "${APP_NAME}"
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        
        // Configuration Serveur Ubuntu
        DEPLOY_SERVER = 'devops@localhost'
        DEPLOY_PATH = '/home/devops/apps'
        SSH_CREDENTIALS_ID = 'ubuntu-server-ssh'
    }
    
    stages {
        // √âTAPE 1: Checkout du code
        stage('Checkout Code') {
            steps {
                checkout scm
                sh '''
                echo "üì¶ Repository: ${GIT_URL}"
                echo "üìù Branch: ${GIT_BRANCH}"
                echo "üîç Files in repository:"
                ls -la
                '''
            }
        }
        
        // √âTAPE 2: V√©rification des fichiers
        stage('Verify Files') {
            steps {
                sh '''
                echo "üîç Checking required files..."
                if [ ! -f "Dockerfile" ]; then
                    echo "‚ùå Dockerfile not found!"
                    exit 1
                fi
                if [ ! -f "*.go" ]; then
                    echo "‚ö†Ô∏è No Go files found in root directory"
                    find . -name "*.go" | head -5
                fi
                echo "‚úÖ Files check completed"
                '''
            }
        }
        
        // √âTAPE 3: Tests statiques Go
        stage('Static Analysis') {
            steps {
                sh '''
                echo "üîç Running static analysis..."
                
                # V√©rification des fichiers Go
                echo "=== Go Files ==="
                find . -name "*.go" -type f | head -10
                
                # Initialisation go.mod si n√©cessaire
                if [ ! -f "go.mod" ]; then
                    echo "üìù Initializing go.mod..."
                    go mod init hello-app
                fi
                
                # T√©l√©chargement des d√©pendances
                echo "üì• Downloading dependencies..."
                go mod download 2>/dev/null || echo "No dependencies"
                
                # Analyse statique de base
                echo "=== Go Vet ==="
                go vet . 2>/dev/null || echo "Go vet completed"
                
                # V√©rification de la compilation
                echo "=== Compilation Check ==="
                go build -o /tmp/test-build . 2>/dev/null && echo "‚úÖ Code compiles successfully" || echo "‚ö†Ô∏è Compilation issues"
                rm -f /tmp/test-build 2>/dev/null || true
                
                echo "‚úÖ Static analysis completed"
                '''
            }
        }
        
        // √âTAPE 4: Tests dynamiques
        stage('Dynamic Tests') {
            steps {
                sh '''
                echo "üß™ Running dynamic tests..."
                mkdir -p test-results
                
                # Tests unitaires basiques
                echo "=== Unit Tests ==="
                if ls *_test.go 1> /dev/null 2>&1; then
                    go test -v -coverprofile=test-results/coverage.out . 2>&1 | tee test-results/test-output.log
                    echo "‚úÖ Unit tests executed"
                else
                    echo "‚ÑπÔ∏è No test files found"
                    echo "no tests" > test-results/test-output.log
                fi
                
                # Test de build final
                echo "=== Final Build Test ==="
                CGO_ENABLED=0 GOOS=linux go build -o hello-app .
                ls -la hello-app
                file hello-app
                
                echo "‚úÖ Dynamic tests completed"
                '''
            }
            
            post {
                always {
                    archiveArtifacts artifacts: 'hello-app,test-results/**/*', fingerprint: true
                }
            }
        }
        
        // √âTAPE 5: Construction image Docker
        stage('Build Docker Image') {
            steps {
                script {
                    sh """
                    echo "üê≥ Building Docker image with your Dockerfile..."
                    echo "=== Dockerfile content ==="
                    cat Dockerfile
                    echo "=========================="
                    
                    # Construction de l'image avec votre Dockerfile
                    docker build -t ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG} .
                    docker tag ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:latest
                    
                    echo "‚úÖ Docker images created:"
                    docker images | grep ${DOCKER_REGISTRY}
                    """
                }
            }
        }
        
        // √âTAPE 6: Push vers Docker Hub
        stage('Push to Docker Hub') {
            steps {
                script {
                    withCredentials([usernamePassword(
                        credentialsId: 'docker-hub-creds',
                        usernameVariable: 'DOCKERHUB_USER',
                        passwordVariable: 'DOCKERHUB_PASS'
                    )]) {
                        sh """
                        echo "üì§ Pushing to Docker Hub..."
                        
                        # Login Docker Hub
                        echo \$DOCKERHUB_PASS | docker login -u \$DOCKERHUB_USER --password-stdin
                        
                        # Push des images
                        docker push ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG}
                        docker push ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:latest
                        
                        # Logout
                        docker logout
                        
                        echo "‚úÖ Images pushed to Docker Hub"
                        echo "üîó https://hub.docker.com/r/${DOCKER_REGISTRY}/${DOCKER_IMAGE}"
                        """
                    }
                }
            }
        }
        
        // √âTAPE 7: D√©ploiement sur Ubuntu via SSH
        stage('Deploy to Ubuntu via SSH') {
            steps {
                script {
                    withCredentials([sshUserPrivateKey(
                        credentialsId: "${SSH_CREDENTIALS_ID}",
                        usernameVariable: 'SSH_USER',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                        echo "üöÄ Deploying to Ubuntu server..."
                        
                        # D√©ploiement direct via SSH
                        ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${DEPLOY_SERVER} "
                            set -e
                            echo 'üéØ Starting deployment of ${APP_NAME}...'
                            
                            # Arr√™t de l'ancien conteneur
                            echo '‚èπÔ∏è Stopping existing container...'
                            docker stop ${APP_NAME} 2>/dev/null || true
                            docker rm ${APP_NAME} 2>/dev/null || true
                            
                            # Pull de la nouvelle image
                            echo 'üì• Pulling new image from Docker Hub...'
                            docker pull ${DOCKER_REGISTRY}/${APP_NAME}:latest
                            
                            # Lancement du nouveau conteneur
                            echo 'üê≥ Starting new container...'
                            docker run -d \\
                              --name ${APP_NAME} \\
                              -p ${APP_PORT}:${APP_PORT} \\
                              --restart unless-stopped \\
                              ${DOCKER_REGISTRY}/${APP_NAME}:latest
                            
                            # Attente du d√©marrage
                            echo '‚è≥ Waiting for application to start...'
                            sleep 10
                            
                            # V√©rification
                            echo 'üîç Verifying deployment...'
                            if docker ps | grep -q ${APP_NAME}; then
                                echo '‚úÖ Container is running'
                            else
                                echo '‚ùå Container failed to start'
                                docker logs ${APP_NAME} --tail 10
                                exit 1
                            fi
                            
                            # Test de sant√©
                            if curl -f -s http://localhost:${APP_PORT}/ > /dev/null; then
                                echo '‚úÖ Health check passed'
                            else
                                echo '‚ö†Ô∏è Health check failed - checking logs...'
                                docker logs ${APP_NAME} --tail 10
                            fi
                            
                            echo 'üéâ Deployment completed!'
                            echo 'üåê App available at: http://localhost:${APP_PORT}'
                            echo 'üåê Network URL: http://192.168.61.131:${APP_PORT}'
                        "
                        """
                    }
                }
            }
        }
        
        // √âTAPE 8: V√©rification finale
        stage('Final Verification') {
            steps {
                script {
                    withCredentials([sshUserPrivateKey(
                        credentialsId: "${SSH_CREDENTIALS_ID}",
                        usernameVariable: 'SSH_USER', 
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                        echo "üîé Final verification..."
                        
                        ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${DEPLOY_SERVER} "
                            echo '=== FINAL DEPLOYMENT STATUS ==='
                            echo 'Container:'
                            docker ps --filter 'name=${APP_NAME}' --format 'table {{.Names}}\\t{{.Status}}\\t{{.Ports}}'
                            
                            echo 'Logs (last 5 lines):'
                            docker logs ${APP_NAME} --tail 5
                            
                            echo 'Port binding:'
                            docker port ${APP_NAME}
                            
                            echo 'Health check:'
                            if curl -f -s -o /dev/null -w 'HTTP Status: %{http_code}\\n' http://localhost:${APP_PORT}/; then
                                echo '‚úÖ APPLICATION IS RUNNING CORRECTLY'
                            else
                                echo '‚ùå APPLICATION HEALTH CHECK FAILED'
                            fi
                        "
                        
                        echo ""
                        echo "üéä DEPLOYMENT SUCCESSFUL!"
                        echo "üìä SUMMARY:"
                        echo "   App: ${APP_NAME}"
                        echo "   Version: ${DOCKER_TAG}" 
                        echo "   URL: http://192.168.61.131:${APP_PORT}"
                        echo "   Image: ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:latest"
                        """
                    }
                }
            }
        }
    }
    
    post {
        always {
            sh '''
            echo "üßº Cleaning up..."
            docker system prune -f 2>/dev/null || true
            rm -f hello-app 2>/dev/null || true
            '''
            
            archiveArtifacts artifacts: 'hello-app,go.mod,*.go', fingerprint: true
        }
        success {
            sh """
            echo ""
            echo "‚úÖ D√âPLOIEMENT R√âUSSI!"
            echo "üåê Votre application Go est maintenant accessible:"
            echo "   Local: http://localhost:${APP_PORT}"
            echo "   R√©seau: http://192.168.61.131:${APP_PORT}"
            echo "üê≥ Image: ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:latest"
            """
        }
        failure {
            sh """
            echo "‚ùå D√âPLOIEMENT √âCHOU√â"
            echo "üìã Consultez les logs ci-dessus pour le diagnostic"
            """
        }
    }
}
