pipeline {
    agent any
    
    triggers {
        githubPush()
        pollSCM('H/5 * * * *')
    }
    
    environment {
        APP_NAME = 'go-dev-dashboard'
        APP_PORT = '8090'
        DOCKER_REGISTRY = 'laurentmd5'
        DEPLOY_SERVER = 'devops@localhost'
        SSH_CREDENTIALS_ID = 'ubuntu-server-ssh'
        TRIVY_VERSION = '0.49.1'
        GOSEC_VERSION = '2.19.0'
        ZAP_VERSION = '2.14.0'
        TARGET_URL = "http://192.168.61.131:${APP_PORT}"
    }
    
    stages {
        // √âTAPE 1: Checkout du Code
        stage('Checkout Code') {
            steps {
                git branch: 'master',
                    url: 'https://github.com/laurentmd5/sample-app.git',
                    credentialsId: 'github-token2'

                sh '''
                echo "üì¶ Repository: https://github.com/laurentmd5/sample-app.git"
                echo "üìù Branch: master"
                echo "üîç Dernier commit:"
                git log -1 --oneline
                echo "üìÅ Contenu du repository:"
                ls -la
                '''
            }
        }
        
        // √âTAPE 2: Setup Environment et Outils de S√©curit√©
        stage('Setup Environment') {
            steps {
                sh '''
                echo "üîß Configuration de l'environnement..."
                echo "=== Versions des outils ==="
                go version || echo "Go non install√©"
                docker --version || echo "Docker non disponible"
                
                echo "üì• Installation des outils de s√©curit√©..."
                
                # Installation de gosec
                echo "=== Installation de gosec ==="
                which gosec || go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
                
                # Installation de Trivy
                echo "=== Installation de Trivy ==="
                if ! which trivy; then
                    wget -q https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.deb
                    sudo dpkg -i trivy_${TRIVY_VERSION}_Linux-64bit.deb
                    rm -f trivy_${TRIVY_VERSION}_Linux-64bit.deb
                fi
                trivy --version || echo "Trivy installation failed"
                
                # Installation de Lynis
                echo "=== Installation de Lynis ==="
                which lynis || (sudo apt update && sudo apt install -y lynis)
                
                echo "‚úÖ Tous les outils sont pr√™ts"
                '''
            }
        }
        
        // √âTAPE 3: Build Application Go
        stage('Build Go Application') {
            steps {
                sh '''
                echo "üèóÔ∏è Construction de l'application Go..."
                
                # Initialisation des modules Go
                if [ ! -f "go.mod" ]; then
                    echo "üìù Initialisation de go.mod..."
                    go mod init hello-app
                fi
                
                # T√©l√©chargement des d√©pendances
                echo "üì• T√©l√©chargement des d√©pendances..."
                go mod download || echo "Aucune d√©pendance ou d√©j√† t√©l√©charg√©es"
                
                # Construction de l'application
                echo "üî® Compilation de l'application..."
                go build -v -o ${APP_NAME} .
                
                # V√©rification du binaire
                echo "‚úÖ V√©rification du build:"
                ls -la ${APP_NAME}
                file ${APP_NAME}
                chmod +x ${APP_NAME}
                '''
            }
        }
        
        // √âTAPE 4: Static Code Analysis - gosec
        stage('Static Code Analysis') {
            steps {
                sh '''
                echo "üîç Analyse Statique du Code avec gosec..."
                mkdir -p security-reports
                
                # Analyse de s√©curit√© avec gosec
                echo "=== Ex√©cution de gosec ==="
                if which gosec; then
                    gosec -fmt=json -out=security-reports/gosec-report.json ./... 2>/dev/null || true
                    gosec -fmt=html -out=security-reports/gosec-report.html ./... 2>/dev/null || true
                    gosec ./... 2>&1 | tee security-reports/gosec-output.txt || echo "Gosec a termin√© avec des findings"
                    echo "‚úÖ Analyse gosec termin√©e"
                else
                    echo "‚ö†Ô∏è gosec non disponible, analyse statique ignor√©e"
                fi
                
                # Analyse suppl√©mentaire avec go vet
                echo "=== Ex√©cution de go vet ==="
                go vet ./... 2>&1 | tee security-reports/govet-output.txt || echo "Go vet termin√©"
                '''
            }
            post {
                always {
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'security-reports',
                        reportFiles: 'gosec-report.html',
                        reportName: 'Rapport Gosec - Analyse Statique'
                    ])
                    archiveArtifacts artifacts: 'security-reports/gosec-report.*,security-reports/govet-output.txt', fingerprint: true
                }
            }
        }
        
        // √âTAPE 5: Dynamic Tests et Couverture
        stage('Dynamic Tests') {
            steps {
                sh '''
                echo "üß™ Tests Dynamiques et Couverture..."
                mkdir -p test-reports
                
                # Tests unitaires avec coverage
                echo "=== Ex√©cution des Tests Unitaires ==="
                go test -v -race -coverprofile=test-reports/coverage.out -covermode=atomic ./... 2>&1 | tee test-reports/test-output.log
                
                # G√©n√©ration des rapports de couverture
                echo "=== G√©n√©ration des Rapports ==="
                go tool cover -html=test-reports/coverage.out -o test-reports/coverage.html
                go tool cover -func=test-reports/coverage.out > test-reports/coverage-summary.txt
                
                # Affichage du r√©sum√©
                echo "=== R√©sum√© de Couverture ==="
                cat test-reports/coverage-summary.txt | grep total || echo "Aucune donn√©e de couverture"
                '''
            }
            post {
                always {
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'test-reports',
                        reportFiles: 'coverage.html',
                        reportName: 'Rapport de Couverture des Tests'
                    ])
                    archiveArtifacts artifacts: 'test-reports/**/*', fingerprint: true
                }
            }
        }
        
        // √âTAPE 6: Construction de l'Image Docker
        stage('Build Docker Image') {
            steps {
                script {
                    sh """
                    echo "üê≥ Construction de l'Image Docker..."
                    
                    # Construction de l'image
                    docker build -t ${DOCKER_REGISTRY}/${APP_NAME}:${env.BUILD_NUMBER} .
                    docker tag ${DOCKER_REGISTRY}/${APP_NAME}:${env.BUILD_NUMBER} ${DOCKER_REGISTRY}/${APP_NAME}:latest
                    
                    echo "‚úÖ Images Docker cr√©√©es:"
                    docker images | grep ${DOCKER_REGISTRY} || echo "Aucune image trouv√©e"
                    """
                }
            }
        }
        
        // √âTAPE 7: Scan de Container - Trivy
        stage('Container Scan') {
            steps {
                sh '''
                echo "üîí Scan de Vuln√©rabilit√©s du Container avec Trivy..."
                mkdir -p trivy-reports
                
                # Scan de l'image Docker
                echo "=== Scan de l'Image Docker ==="
                trivy image --format template --template "@contrib/html.tpl" -o trivy-reports/container-scan.html ${DOCKER_REGISTRY}/${APP_NAME}:latest
                trivy image --format json -o trivy-reports/container-scan.json ${DOCKER_REGISTRY}/${APP_NAME}:latest
                trivy image --exit-code 0 --severity HIGH,CRITICAL ${DOCKER_REGISTRY}/${APP_NAME}:latest
                
                echo "‚úÖ Scan du container termin√©"
                '''
            }
            post {
                always {
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'trivy-reports',
                        reportFiles: 'container-scan.html',
                        reportName: 'Scan S√©curit√© Container - Trivy'
                    ])
                    archiveArtifacts artifacts: 'trivy-reports/container-scan.*', fingerprint: true
                }
            }
        }
        
        // √âTAPE 8: Scan du Filesystem - Trivy FS
        stage('Filesystem Scan') {
            steps {
                sh '''
                echo "üìÅ Scan du Filesystem et D√©pendances..."
                mkdir -p trivy-reports
                
                # Scan du filesystem
                echo "=== Scan des D√©pendances ==="
                trivy filesystem --format template --template "@contrib/html.tpl" -o trivy-reports/fs-scan.html .
                trivy filesystem --format json -o trivy-reports/fs-scan.json .
                trivy filesystem --exit-code 0 --severity HIGH,CRITICAL .
                
                echo "‚úÖ Scan du filesystem termin√©"
                '''
            }
            post {
                always {
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'trivy-reports',
                        reportFiles: 'fs-scan.html',
                        reportName: 'Scan S√©curit√© Filesystem - Trivy'
                    ])
                    archiveArtifacts artifacts: 'trivy-reports/fs-scan.*', fingerprint: true
                }
            }
        }
        
        // √âTAPE 9: D√©ploiement sur Ubuntu
        stage('Deploy to Ubuntu') {
            steps {
                script {
                    withCredentials([sshUserPrivateKey(
                        credentialsId: "${SSH_CREDENTIALS_ID}",
                        usernameVariable: 'SSH_USER',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                        echo "üöÄ D√©ploiement sur le serveur Ubuntu..."
                        
                        ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${DEPLOY_SERVER} "
                            set -e
                            echo 'üéØ D√©marrage du d√©ploiement...'
                            
                            # Arr√™t de l'ancien conteneur
                            docker stop ${APP_NAME} 2>/dev/null || true
                            docker rm ${APP_NAME} 2>/dev/null || true
                            
                            # Lancement du nouveau conteneur
                            docker run -d \\
                              --name ${APP_NAME} \\
                              -p ${APP_PORT}:${APP_PORT} \\
                              --restart unless-stopped \\
                              ${DOCKER_REGISTRY}/${APP_NAME}:latest
                            
                            # Attente du d√©marrage
                            sleep 15
                            
                            # V√©rification
                            docker ps --filter 'name=${APP_NAME}' --format 'table {{.Names}}\\t{{.Status}}\\t{{.Ports}}'
                            
                            echo '‚úÖ D√©ploiement termin√© avec succ√®s'
                        "
                        """
                    }
                }
            }
        }
        
        // √âTAPE 10: Installation OWASP ZAP sur le Serveur
        stage('Install OWASP ZAP') {
            steps {
                script {
                    withCredentials([sshUserPrivateKey(
                        credentialsId: "${SSH_CREDENTIALS_ID}",
                        usernameVariable: 'SSH_USER',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                        echo "üì• Installation d'OWASP ZAP sur le serveur..."
                        
                        ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${DEPLOY_SERVER} "
                            # V√©rifier si ZAP est d√©j√† install√©
                            if which zap-baseline.py; then
                                echo '‚úÖ ZAP d√©j√† install√©'
                            else
                                echo 'üì• Installation de ZAP...'
                                sudo apt update
                                sudo apt install -y default-jre wget
                                wget -q https://github.com/zaproxy/zaproxy/releases/download/v${ZAP_VERSION}/zap_${ZAP_VERSION}_all.deb
                                sudo dpkg -i zap_${ZAP_VERSION}_all.deb || sudo apt-get install -f -y
                                sudo apt install -y zaproxy
                                rm -f zap_${ZAP_VERSION}_all.deb
                                echo '‚úÖ ZAP install√© avec succ√®s'
                            fi
                        "
                        """
                    }
                }
            }
        }
        
        // √âTAPE 11: Scan Dynamique - OWASP ZAP
        stage('OWASP ZAP Security Scan') {
            steps {
                script {
                    withCredentials([sshUserPrivateKey(
                        credentialsId: "${SSH_CREDENTIALS_ID}",
                        usernameVariable: 'SSH_USER',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                        echo "üõ°Ô∏è Scan de S√©curit√© Dynamique OWASP ZAP..."
                        mkdir -p zap-reports
                        
                        # Ex√©cution du scan ZAP sur le serveur
                        ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${DEPLOY_SERVER} "
                            echo '=== D√©marrage du Scan ZAP ==='
                            
                            # Attendre que l'application soit pr√™te
                            sleep 30
                            
                            # Scan baseline ZAP
                            zap-baseline.py -t ${TARGET_URL} -I -m 5 -T 10 -J -j -x /home/devops/zap-report.xml -r /home/devops/zap-report.html 2>&1 | tee /home/devops/zap-scan.log || echo 'Scan ZAP termin√© avec des findings'
                            
                            # Nettoyage des processus ZAP
                            pkill -f zaproxy 2>/dev/null || true
                            echo '‚úÖ Scan ZAP termin√©'
                        "
                        
                        # R√©cup√©ration des rapports ZAP
                        scp -i \$SSH_KEY -o StrictHostKeyChecking=no ${DEPLOY_SERVER}:/home/devops/zap-report.html zap-reports/ || echo 'Rapport HTML non disponible'
                        scp -i \$SSH_KEY -o StrictHostKeyChecking=no ${DEPLOY_SERVER}:/home/devops/zap-report.xml zap-reports/ || echo 'Rapport XML non disponible'
                        """
                    }
                }
            }
            post {
                always {
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'zap-reports',
                        reportFiles: 'zap-report.html',
                        reportName: 'Scan S√©curit√© Dynamique - OWASP ZAP'
                    ])
                    archiveArtifacts artifacts: 'zap-reports/**/*', fingerprint: true
                }
            }
        }
        
        // √âTAPE 12: Audit Environnement - Lynis
        stage('Environment Scan') {
            steps {
                script {
                    withCredentials([sshUserPrivateKey(
                        credentialsId: "${SSH_CREDENTIALS_ID}",
                        usernameVariable: 'SSH_USER',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                        echo "üè¢ Audit de S√©curit√© de l'Environnement..."
                        mkdir -p lynis-reports
                        
                        # Audit du serveur avec Lynis
                        ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${DEPLOY_SERVER} "
                            echo '=== Audit Syst√®me avec Lynis ==='
                            sudo lynis audit system --quick 2>&1 | tee /tmp/lynis-audit.txt
                            
                            echo '=== V√©rification des Mises √† Jour ==='
                            sudo apt update && sudo apt list --upgradable 2>/dev/null | head -10 | tee /tmp/security-updates.txt
                        "
                        
                        # R√©cup√©ration des rapports - CORRECTION APPLIQU√âE ICI
                        scp -i \$SSH_KEY -o StrictHostKeyChecking=no ${DEPLOY_SERVER}:/tmp/lynis-audit.txt lynis-reports/ || echo 'Rapport Lynis non disponible'
                        scp -i \$SSH_KEY -o StrictHostKeyChecking=no ${DEPLOY_SERVER}:/tmp/security-updates.txt lynis-reports/ || echo 'Rapport updates non disponible'
                        """
                    }
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'lynis-reports/**/*', fingerprint: true
                }
            }
        }
        
        // √âTAPE 13: Rapport de S√©curit√© Consolid√©
        stage('Security Summary') {
            steps {
                sh '''
                echo "üìä G√©n√©ration du Rapport de S√©curit√© Consolid√©..."
                
                # G√©n√©ration du rapport Markdown
                cat > security-summary.md << EOF
                # Rapport de S√©curit√© Complet - Build ${BUILD_NUMBER}
                
                ## üìÖ Date: $(date)
                ## üè∑Ô∏è Application: ${APP_NAME}
                ## üåê URL: ${TARGET_URL}
                
                ## üîç Analyse Statique
                - **Gosec**: $(ls security-reports/gosec-report.html 2>/dev/null && echo "‚úÖ Compl√©t√©" || echo "‚ùå √âchou√©")
                - **Go Vet**: $(ls security-reports/govet-output.txt 2>/dev/null && echo "‚úÖ Compl√©t√©" || echo "‚ùå √âchou√©")
                
                ## üß™ Tests Dynamiques
                - **Couverture**: $(if [ -f "test-reports/coverage-summary.txt" ]; then cat test-reports/coverage-summary.txt | grep total | awk "{print \\$3}"; else echo "N/A"; fi)
                
                ## üîí S√©curit√© Container
                - **Scan Image**: $(ls trivy-reports/container-scan.html 2>/dev/null && echo "‚úÖ Compl√©t√©" || echo "‚ùå √âchou√©")
                - **Scan Filesystem**: $(ls trivy-reports/fs-scan.html 2>/dev/null && echo "‚úÖ Compl√©t√©" || echo "‚ùå √âchou√©")
                
                ## üõ°Ô∏è S√©curit√© Dynamique
                - **OWASP ZAP**: $(ls zap-reports/zap-report.html 2>/dev/null && echo "‚úÖ Compl√©t√©" || echo "‚ùå √âchou√©")
                
                ## üè¢ Environnement
                - **Audit Lynis**: $(ls lynis-reports/lynis-audit.txt 2>/dev/null && echo "‚úÖ Compl√©t√©" || echo "‚ùå √âchou√©")
                
                ## üìà Statut Global
                - **Build**: ${currentBuild.result}
                - **Application**: $(curl -s -o /dev/null -w "%{http_code}" ${TARGET_URL} || echo "Inaccessible")
                
                EOF
                
                # Copie simple sans pandoc
                cp security-summary.md security-reports/security-summary.html
                
                echo "‚úÖ Rapport de s√©curit√© g√©n√©r√©"
                '''
            }
            post {
                always {
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'security-reports',
                        reportFiles: 'security-summary.html',
                        reportName: 'R√©sum√© S√©curit√© Complet'
                    ])
                    archiveArtifacts artifacts: 'security-summary.md,security-reports/security-summary.html', fingerprint: true
                }
            }
        }
        
        // √âTAPE 14: V√©rification Finale
        stage('Final Check') {
            steps {
                script {
                    withCredentials([sshUserPrivateKey(
                        credentialsId: "${SSH_CREDENTIALS_ID}",
                        usernameVariable: 'SSH_USER',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                        echo "üéØ V√©rification Finale..."
                        
                        ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${DEPLOY_SERVER} "
                            echo 'üìä √âtat Final du D√©ploiement'
                            echo '============================'
                            
                            # Statut de l'application
                            docker ps --filter 'name=${APP_NAME}' --format 'table {{.Names}}\\t{{.Status}}\\t{{.Ports}}'
                            
                            # Sant√© de l'application
                            if curl -f -s ${TARGET_URL} > /dev/null; then
                                echo '‚úÖ APPLICATION EN LIGNE ET FONCTIONNELLE'
                            else
                                echo '‚ùå APPLICATION INACCESSIBLE'
                            fi
                            
                            echo ''
                            echo 'üéâ D√âPLOIEMENT ET SCANS TERMIN√âS AVEC SUCC√àS!'
                            echo 'üåê Application disponible: ${TARGET_URL}'
                        "
                        """
                    }
                }
            }
        }
    }
    
    post {
        always {
            sh '''
            echo "üßπ Nettoyage final..."
            docker system prune -f 2>/dev/null || true
            
            echo ""
            echo "üìä R√âSUM√â DE L'\''EX√âCUTION"
            echo "========================="
            echo "‚úÖ Application Go construite"
            echo "‚úÖ Image Docker cr√©√©e"
            echo "‚úÖ Tests et couverture ex√©cut√©s"
            echo "‚úÖ Scans de s√©curit√© compl√©t√©s"
            echo "‚úÖ Application d√©ploy√©e"
            echo ""
            echo "üìã RAPPORTS DISPONIBLES:"
            echo "   - üîç Gosec: Analyse statique"
            echo "   - üß™ Tests: Couverture et r√©sultats"
            echo "   - üîí Trivy: Scan containers et fichiers"
            echo "   - üõ°Ô∏è ZAP: Scan dynamique"
            echo "   - üè¢ Lynis: Audit environnement"
            echo "   - üìä R√©sum√© s√©curit√© complet"
            '''
            
            // Archivage de tous les rapports
            archiveArtifacts artifacts: 'security-reports/**,test-reports/**,trivy-reports/**,zap-reports/**,lynis-reports/**,${APP_NAME}', fingerprint: true
        }
        success {
            sh """
            echo ""
            echo "üéâ PIPELINE DE S√âCURIT√â COMPLET R√âUSSI!"
            echo "======================================="
            echo "üõ°Ô∏è  Tous les contr√¥les de s√©curit√© ont pass√©"
            echo "üöÄ  Application d√©ploy√©e s√©curitairement"
            echo "üåê  Acc√©dez √† l'application: ${TARGET_URL}"
            """
        }
        failure {
            sh """
            echo "‚ùå PIPELINE EN √âCHEC"
            echo "==================="
            echo "üí° Consultez les rapports pour plus de d√©tails"
            """
        }
    }
}
