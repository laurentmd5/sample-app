pipeline {
    agent any
    
    environment {
        // Configuration Application
        APP_NAME = 'go-dev-dashboard'
        APP_PORT = '8090'
        
        // Configuration Docker
        DOCKER_REGISTRY = 'laurentmd5'
        DOCKER_IMAGE = "${APP_NAME}"
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        
        // Configuration Serveur Ubuntu
        DEPLOY_SERVER = 'devops@localhost'
        DEPLOY_PATH = '/home/devops/apps'
        SSH_CREDENTIALS_ID = 'ubuntu-server-ssh'
        
        // Configuration Go
        GOPATH = '/var/lib/jenkins/go'
    }
    
    stages {
        // √âTAPE 1: Checkout avec credentials GitHub
        stage('Checkout Code') {
            steps {
                git branch: 'master',
                    url: 'https://github.com/laurentmd5/sample-app.git',
                    credentialsId: 'my-token'

                sh '''
                echo "üì¶ Repository: https://github.com/laurentmd5/sample-app.git"
                echo "üìù Branch: master"
                echo "üîç Files in repository:"
                ls -la
                echo "=== Go files ==="
                find . -name "*.go" -type f
                '''
            }
        }
        
        // √âTAPE 2: Setup Go Environment
        stage('Setup Go') {
            steps {
                sh '''
                echo "üîß Setting up Go environment..."
                echo "Go version:"
                go version
                echo "Go path:"
                which go
                
                # Cr√©er le workspace Go pour Jenkins
                mkdir -p /var/lib/jenkins/go
                chown jenkins:jenkins /var/lib/jenkins/go
                
                # V√©rifier les permissions
                echo "Current user:"
                whoami
                echo "Workspace:"
                pwd
                '''
            }
        }
        
        // √âTAPE 3: Build application Go
        stage('Build Go Application') {
            steps {
                sh '''
                echo "üèóÔ∏è Building Go application..."
                
                # V√©rifier le fichier main.go
                echo "=== Main Go file ==="
                cat main.go | head -10
                
                # Initialiser go.mod si absent
                if [ ! -f "go.mod" ]; then
                    echo "üìù Initializing go.mod..."
                    go mod init hello-app
                fi
                
                # T√©l√©charger les d√©pendances
                echo "üì• Downloading dependencies..."
                go mod download || echo "No dependencies or already downloaded"
                
                # Build de l'application
                echo "üî® Compiling application..."
                go build -v -o ${APP_NAME} .
                
                # V√©rification
                echo "‚úÖ Build completed:"
                ls -la ${APP_NAME}
                file ${APP_NAME}
                ./${APP_NAME} --version 2>/dev/null || ./${APP_NAME} -v 2>/dev/null || echo "Cannot test binary (expected)"
                '''
            }
        }
        
        // √âTAPE 4: Tests statiques simplifi√©s
        stage('Static Analysis') {
            steps {
                sh '''
                echo "üîç Running static analysis..."
                
                # V√©rification de base
                echo "=== Basic Checks ==="
                go vet . 2>/dev/null && echo "‚úÖ Go vet passed" || echo "‚ö†Ô∏è Go vet issues"
                
                # V√©rification compilation
                echo "=== Compilation ==="
                go build -o /tmp/test-build . && echo "‚úÖ Code compiles" || echo "‚ùå Compilation failed"
                rm -f /tmp/test-build
                
                echo "‚úÖ Static analysis completed"
                '''
            }
        }
        
        // √âTAPE 5: Construction image Docker
        stage('Build Docker Image') {
            steps {
                script {
                    sh """
                    echo "üê≥ Building Docker image..."
                    
                    # V√©rifier le Dockerfile
                    echo "=== Dockerfile Content ==="
                    cat Dockerfile
                    echo "=========================="
                    
                    # Construction de l'image
                    docker build -t ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG} .
                    docker tag ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:latest
                    
                    echo "‚úÖ Docker images created:"
                    docker images | grep ${DOCKER_REGISTRY}
                    """
                }
            }
        }
        
        // √âTAPE 6: D√©ploiement sur Ubuntu
        stage('Deploy to Ubuntu via SSH') {
            steps {
                script {
                    withCredentials([sshUserPrivateKey(
                        credentialsId: "${SSH_CREDENTIALS_ID}",
                        usernameVariable: 'SSH_USER',
                        keyFileVariable: 'SSH_KEY'
                    )]) {
                        sh """
                        echo "üöÄ Deploying to Ubuntu server..."
                        
                        ssh -i \$SSH_KEY -o StrictHostKeyChecking=no ${DEPLOY_SERVER} "
                            set -e
                            echo 'üéØ Starting deployment of ${APP_NAME}...'
                            
                            # Arr√™t ancien conteneur
                            echo '‚èπÔ∏è Stopping existing container...'
                            docker stop ${APP_NAME} 2>/dev/null || true
                            docker rm ${APP_NAME} 2>/dev/null || true
                            
                            # Nettoyage
                            echo 'üßπ Cleaning up...'
                            docker image prune -f 2>/dev/null || true
                            
                            # Lancement nouveau conteneur (utilise l'image locale)
                            echo 'üê≥ Starting new container...'
                            docker run -d \\
                              --name ${APP_NAME} \\
                              -p ${APP_PORT}:${APP_PORT} \\
                              --restart unless-stopped \\
                              ${DOCKER_REGISTRY}/${APP_NAME}:latest
                            
                            # V√©rification
                            echo '‚è≥ Waiting for startup...'
                            sleep 10
                            
                            echo 'üîç Verification:'
                            docker ps --filter 'name=${APP_NAME}' --format 'table {{.Names}}\\t{{.Status}}'
                            
                            # Test sant√©
                            if curl -f -s http://localhost:${APP_PORT}/ > /dev/null; then
                                echo '‚úÖ Health check passed'
                                echo 'üéâ Deployment successful!'
                                echo 'üåê Application URL: http://localhost:${APP_PORT}'
                                echo 'üåê Network URL: http://192.168.61.131:${APP_PORT}'
                            else
                                echo '‚ö†Ô∏è Health check failed - checking logs...'
                                docker logs ${APP_NAME} --tail 10
                                echo '‚ö†Ô∏è Deployment completed but health check failed'
                            fi
                        "
                        """
                    }
                }
            }
        }
    }
    
    post {
        always {
            sh '''
            echo "üßº Cleaning up workspace..."
            docker system prune -f 2>/dev/null || true
            rm -f ${APP_NAME} 2>/dev/null || true
            '''
            
            archiveArtifacts artifacts: '${APP_NAME},go.mod,*.go', fingerprint: true
        }
        success {
            sh """
            echo ""
            echo "‚úÖ D√âPLOIEMENT R√âUSSI!"
            echo "üåê Votre application Go est d√©ploy√©e:"
            echo "   http://localhost:${APP_PORT}"
            echo "   http://192.168.61.131:${APP_PORT}"
            echo "üê≥ Image: ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:latest"
            """
        }
        failure {
            sh """
            echo "‚ùå D√âPLOIEMENT √âCHOU√â"
            echo "üí° Causes possibles:"
            echo "   - Probl√®me de build Go"
            echo "   - Dockerfile incorrect"
            echo "   - Probl√®me SSH"
            echo "   - Port ${APP_PORT} d√©j√† utilis√©"
            """
        }
    }
}
